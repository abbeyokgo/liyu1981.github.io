---
published: false
---

## 为什么要理解一个服务器OS的系统服务体系？

因为作为一个服务器OS，实际上与管理员与用户有关系的，能感受到的，主要就是这些跑在后台的服务。

打个比方，手机OS不刷不死心人，整天关心的就是后台都跑了多少服务，应该怎么杀。那么对比服务器OS折腾星人，不了解后台到底都是跑的些啥，显然不专业。（当然就不要想着杀了，会杀出问题来。）

所以，想要显摆自己有多精通一个服务器OS，不入门到精通这些后台服务是不行的。

DogeOS目前本质上就是SmartOS，以下的内容适用于SmartOS。由于SmartOS来源于illumos，所以也适用于所有illumos派生的操作系统。

## 从SMF框架说起

DogeOS/SmartOS继承了illumos的衣钵，系统服务组织上，采用了一种叫做SMF的先进框架。因此我们要先理解什么是SMF？

从维基百科上可以找到[这东西的页面](http://en.wikipedia.org/wiki/Service_Management_Facility)，摘录并翻译如下

> Service Management Facility (SMF) 是Solaris操作系统引入的一项功能，它能创建可维护的，统一的服务与服务管理模型，它取代了init.d。

看到这里我相信大家都有一个呼声：

**能不能说人话？**

好吧说人话。

直白的说就是Solaris的那帮开发者（现在是illumos的开发者）看unix/linux的init.d十分不爽，就另行开发了一个系统取代之。这个系统称之为SMF，这个系统将解决一些在*nix系统服务里面积累多年的问题。

## *nix系统服务到底有啥问题？

老实说，这不是一个很容易让人意识到其重要性的问题。因为大部分一辈子，遇到这东西几率不高。

*nix系统，以及大部分呢的linux系统，使用的系统服务框架为之[init](http://en.wikipedia.org/wiki/Init)。简单的总结，init是*nix系统在内核启动之后，所启动的第一个应用程序，由它再来负责启动之后的所有的应用程序与服务。

形象的说，*nix系统的启动是这样的

1. 当你按下机箱上面的那个电源键之后，它就傻傻的去直接执行储存在主板上的应用程序（即BIOS）; 
2. BIOS一根筋的检测完硬件之后，一般就去启动主硬盘的引导区的那个引导程序（通常在Linux系统，它叫做grub）; 
3. grub会做一些初始化文件系统的脏活儿，读取一个配置文件，去启动你真正想要的内核;
4. 内核在这个时候被载入内存启动了，跟前面步骤的那些应用程序执行完了就把自己杀掉不同，内核不会，它会把你的机器硬件弄成可以共享的形式，欢迎后面的应用程序来共享使用;
5. 内核是不直接过问具体事物的，它会启动一个新的应用程序，来负责启动其他的应用程序。

最后那个应用程序就是init。

作为所有后面应用程序的入口，大家应该都意识到了，这是流量的入口啊，怎么管理好这个入口有大学问。比如怎么雁过拔毛，收收买路钱，甚至强迫别人内置几个广告的事情，这事情大家应该都心里有数，我明白的。

但是init是70年代就诞生的，那时候人心还挺淳朴，所以init也特别的头脑简单。

**所有需要让我启动的程序，一个一个来**

有入口的地方就有江湖，谁先谁后怎么插队一直是人民群众特别关心的问题。在init的简单规则下，最后发展成了按照运行等级（run level）和名字字母顺序一个一个来。所以想插队，调高自己的等级，或者改个能排在前面的名字。

显然这一套能运作30多年就是个奇迹。

想一想，这一套至少会有这些问题

1. 等级划分太简单了。*nix一般就6个运行等级，其中level 0和6有特殊含义，level 4被保留了。能用就1，3和5。特权阶级和非特权阶级通通挤在一起，有啥事儿不能听领导的再行动（即依赖关系）。
2. 一个一个来，那万一有人耍赖怎么办？比如网络方面的服务只要排在tcp/ip相关的服务后面即可以，但是文件系统排在更前面，它要是出点问题还要影响网络这边的事儿。
3. 都是用root来执行的。这个对一些关键服务还可以说，但是什么打印机啊之类的有必要么？人家黑了你打印机服务就顺带端掉了整个系统。
4. init启动过一次就不管了，之后这些服务就自生自灭，这可不好，至少得有个自动重启什么的服务吧。

## 回到SMF

SMF的发明者将*nix的问题总结了一下，在创造SMF这个init的替代者，它有如下特点

1. 引入依赖关系。一个服务可以依赖另几个服务，满足不了条件就不起动或者暂停。
2. 引入权限控制。打印机服务这种让[linus都抓狂的服务](http://lkml.iu.edu//hypermail/linux/kernel/1306.1/00108.html)，就让它在低权限跑去吧。
3. 引入守护机制。死了帮你重启，重启不成就帮你暂停，以及暂停其他所有依赖这个服务。

