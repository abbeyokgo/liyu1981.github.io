---
layout: post
title: 谈谈CRDT
description: CRDT是什么？为什么我们需要它？
category: blog
published: false
---

[http://www.project-fifo.net](Project FiFo) 0.6.0的release note中有这样一条：全面采用CRDT作为底层数据结构。为什么要采用CRDT，有啥好处，其实是不太容易理解的。在这里，我就试图用听的懂的语言来解释一下CRDT是什么，以及为什么采用它是一个巨大的进步。

## CRDT是什么？

CRDT是Conflict-Free Replicated Data Types的缩写，直译的话即“无冲突可复制数据类型”。简单讲，翻译过来这不是人话。所以接下来还是保留其英文缩写称呼之。

研究分布式系统，尤其是研究最终一致性分布式系统的过程中，一个最基本的问题就是，应该采用什么样的数据结构来保证最终一致性？CRDT即是理论界目前对于这个问题的答案（一篇集大成的论文在[这里](http://hal.upmc.fr/docs/00/55/55/88/PDF/techreport.pdf)）。

当然理论界的思路现在不是所有人能跟上的，需要更加简单的解释。

先来回忆一下中学时候我们都会学习的那些基础定理，它们通常是如果X要具有某种性质，则X必须满足性质12345这样的形式，例如如果一元二次方程要有实数解，则其系数需要满足一个[具体的性质](http://wenku.baidu.com/view/32c156200722192e4536f6db.html)。现代研究的理论成果也起是还是在这条路上进行，因此关于CRDT，形象的讲，就是如果设计实现一个分布式系统能达到最终一致性，那么它所采用的数据结构必须具有一些基本性质。理论界将这样的数据结构命名为CRDT，搞清楚了CRDT应该满足的基本性质，以及不断的在扩展CRDT的各种实现，以及使得它们更加高校的办法。

当然这样还不够。要清楚的解释一个东西，最好还是将其来龙去脉都讲一下才清楚。

### 最终一致性的难题

首先我们来看一下分布式系统以及最终一致性问题。

分布式系统，顾名思义，其实就是用很多一样的机器跑同样的程序，使得外界看起来象一个超级系统。我们处理的数据越来越多，但是单个计算机的处理能力是远远跟不上的，所以我们需要分布式的系统，来合并处理能力也好，来应对事故也好，总之这里有需要也有必要。

如果分布式系统里面的每一个子程序都是无状态的，那么分布式系统的建设是相当简单的。举例来说，写一个简单的hello world这样的东西，然后每个机器都装上，分布式的大家一起hello world，死机了就重启。那么这个分布式系统是相当简单的，随便一个高中生应该都能写的出来。

如果这个分布式系统是用来存储数据的呢？例如，大家现在都会说两句的NoSQL数据库系统，事情会变成如何呢？

一开始我们会觉得很简单，NoSQL就是一个key一个value，用户无非是存进来取出去。就算分布式，那也就是按照key给用户分个区，不同的key指向不同的机器。
刚开始思考一下，感觉也就是一个下午或者周末就可以完成的。

但是事情在开始思考这些问题之后变得复杂：如果机器出现故障？如果网络出现故障？如果故障出现之后又自动修复了？

第一个问题的难点在与如何取代出现故障的机器。这里我们有一致性hash的答案：将所有的机器组织成一个环，寻找环上下一个节点来接替故障机器的工作。第二个问题与第一个问题类似，仅仅需要故障的机器自身的程序做一些处理，例如在故障出现之后，感知到这种问题，做好准备。

难的是第三个问题，因为它涉及到了一致性。而且这个问题本身还具有很多不明的部分，例如

1. 故障机器是从空白状态恢复过来，还是带有历史遗留的数据？
2. 故障机器在故障的这段时间之内，别的机器有帮它处理过数据么？
3. 故障机器恢复过来之后，有一些用户访问了它，并且存储了一些数据，同时另一些用户也存储了一些可能产生冲突的数据在替代机器上，那么怎么合并这些数据，保持正确性？（这就是著名的脑裂问题）。

### Vector Clock

## 理论界的答案

## 如何使用？谁在使用？

## 一句话总结

