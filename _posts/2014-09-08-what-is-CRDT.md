---
layout: post
title: 谈谈CRDT
description: CRDT是什么？为什么我们需要它？
category: blog
published: false
---

[http://www.project-fifo.net](Project FiFo) 0.6.0的release note中有这样一条：全面采用CRDT作为底层数据结构。为什么要采用CRDT，有啥好处，其实是不太容易理解的。在这里，我就试图用听的懂的语言来解释一下CRDT是什么，以及为什么采用它是一个巨大的进步。

## CRDT是什么？

CRDT是Conflict-Free Replicated Data Types的缩写，直译的话即“无冲突可复制数据类型”。简单讲，翻译过来这不是人话。所以接下来还是保留其英文缩写称呼之。

研究分布式系统，尤其是研究最终一致性分布式系统的过程中，一个最基本的问题就是，应该采用什么样的数据结构来保证最终一致性？CRDT即是理论界目前对于这个问题的答案（一篇集大成的论文在[这里](http://hal.upmc.fr/docs/00/55/55/88/PDF/techreport.pdf)）。

当然理论界的思路现在不是所有人能跟上的，需要更加简单的解释。

## 一致性的难题

先看一下分布式系统。分布式系统的好处，不用说了，这是人类目前唯一实际可行的构建超大规模系统的唯二办法之一（另一种就是超级计算机）。如果考虑上经济可行这个因素，那么分布式系统就是唯一可行之法。

构建分布式系统，抛开效率问题不谈，首先是如何保持其正确性？

简单的讲，构建一个分布式系统跑得飞快完全不难，只有构建一个运作起来正确性与单机程序完全无二的分布式系统，这才困难。

现实上，就算这个理想中的目标也是无法达成的（至少在目前的计算机体系结构下）。这就要说到CAP定理。CAP定理告诉我们，在构建分布式系统的时候，Consistency（一致性），Availability（可用性），Partition tolerance（分区容错性），这三者只可以同时选择两样。

即，就算给我们再多的钱，在目前的计算机体系结构下，三样同时选择，理论上无可能的。如果谁做到了？就是不科学。

可惜的是，分区容错性是实际运行的分布式系统所必需的。设想下，谁能保证系统的各节点永远保持网络联通？（这是不给GFW面子）。

所以接下来我们需要在一致性和可用性中二选其一。

选择一致性，构建的就是强一致性系统。选择可用性，构建的就是最终一致性系统。前者的特点是数据落地即是一致的，但是可用性可能会有下降，实际中就是，有时系统在忙着保证一致性，无法对外界服务。后者的特点是时时刻刻都保证可用性，用户随时都可以访问，但是各个节点之间会存在不一致的时刻。

需要注意的是最终一致性的系统不是不保证一致性，而是不在保证可用性和分区容错性的同时保证一致性。

最终我们还是要在最终一致性的各节点之间处理数据，使他们达到一致。

## 需要保存怎样的信息才可能达到最终一致？

因为最终一致性系统保证可用性与分区容错性，所以在构建去中心，无单点故障，总是可用的系统时，会是更好的选择。

那么我们就一定需要在某个时刻处理这个一致性问题。

举个例子，我们设想一个最终一致的分布式系统，处理一个账户的支出收入问题。假设这个账户是T，初始化有100块钱吧，系统里面有好几个节点例如A, B, C都想访问它。那么我们的最终一致的分布式系统，可以保证A B C三者在时时刻刻都可以对T进行操作。

假设某个时刻t1，A往T中存了10块钱，B则向T中取了10块钱，C则在接下来的一个时刻查询T有多少钱，他们是同时发生的。

显然，分布式系统会保证这三个操作都能完成，于是

1. 在服务A的系统看来，T有110块钱;
2. 在服务B的系统看来，T有90块钱;
3. 在服务C的系统看来，T有100块钱。

在这个时刻t1，这三者都是对的，即最终一致性系统中，存在不一致的时刻。那么经过一段时间之后，假设是t2吧，我们需要使得服务A B和C的系统看来，T都有100块钱，即保证最终一致。

这中间肯定需要做一些操作，例如服务A B和C的系统之间交换一些必要的信息数据。

问题是：这些需要被交换的数据至少需要是怎样的？

如果在各节点我们只是存了T的余额，例如用一个整数变量，这样显然是不行的。

## 再谈CRDT

## 如何使用？谁在使用？

## 一句话总结

